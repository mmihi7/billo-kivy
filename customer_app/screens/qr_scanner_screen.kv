#:import ZBarCam kivy_garden.zbarcam.ZBarCam
#:import ZBarSymbol pyzbar.pyzbar.ZBarSymbol
#:import Window kivy.core.window.Window
#:import Line kivy.graphics.Line

<QRScannerScreen>:
    name: 'qr_scanner'
    scan_result: ''
    is_scanning: False
    demo_mode: False
    
    BoxLayout:
        orientation: 'vertical'
        padding: dp(16)
        spacing: dp(16)
        size_hint_y: None
        height: Window.height
        
        # Header with back button
        BoxLayout:
            size_hint_y: None
            height: dp(56)
            padding: [0, 0, 0, dp(8)]
            
            MDIconButton:
                icon: 'arrow-left'
                on_release: app.root.current = 'dashboard'
                theme_text_color: 'Primary'
                size_hint: None, None
                size: dp(48), dp(48)
                pos_hint: {'center_y': 0.5}
                
            MDLabel:
                text: 'Connect to Restaurant'
                font_style: 'H5'
                halign: 'left'
                size_hint_x: 0.8
                font_size: '20sp'
                
        # Camera Preview or Demo QR Code
        BoxLayout:
            orientation: 'vertical'
            size_hint: 1, 0.7
            spacing: dp(16)
            
            # Demo mode content (initially hidden)
            BoxLayout:
                id: demo_content
                orientation: 'vertical'
                size_hint: 1, 1
                spacing: dp(16)
                opacity: 1 if root.demo_mode else 0
                disabled: not root.demo_mode
                
                MDLabel:
                    text: 'Demo Mode'
                    font_style: 'H6'
                    halign: 'center'
                    size_hint_y: None
                    height: self.texture_size[1]
                    font_size: '18sp'
                    theme_text_color: 'Secondary'
                    
                # Square QR Code Placeholder
                RelativeLayout:
                    size_hint: None, 0.6
                    width: self.height
                    pos_hint: {'center_x': 0.5}
                    canvas:
                        Color:
                            rgba: 0.9, 0.9, 0.9, 1
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [dp(8)]
                            
                    MDIcon:
                        icon: 'qrcode-scan'
                        font_size: '64sp'
                        theme_text_color: 'Secondary'
                        pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                    
                MDLabel:
                    text: 'Demo Restaurant QR Code'
                    font_style: 'Body1'
                    halign: 'center'
                    size_hint_y: None
                    height: self.texture_size[1]
                    font_size: '16sp'
                
                MDRaisedButton:
                    id: use_demo_btn
                    text: 'USE DEMO RESTAURANT'
                    size_hint: 0.8, None
                    height: dp(50)
                    pos_hint: {'center_x': 0.5}
                    on_release: root.on_qr_code_scanned('restaurant:demo_restaurant_123')
                    md_bg_color: 0.3, 0.7, 0.3, 1
                    font_size: '16sp'
                    bold: True
            
            # Camera preview (initially hidden on non-Android)
            RelativeLayout:
                id: camera_container
                size_hint: 1, 1
                opacity: 0 if root.demo_mode else 1
                disabled: root.demo_mode
                
                # This will be replaced with the actual camera widget
                # when the screen is loaded
                
                # Simple scanner frame
                BoxLayout:
                    size_hint: 0.8, 0.8
                    pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                    canvas.before:
                        # Semi-transparent overlay
                        Color:
                            rgba: 0, 0, 0, 0.5
                        Rectangle:
                            pos: self.pos
                            size: self.size
                        
                        # White border
                        Color:
                            rgba: 1, 1, 1, 1
                        Line:
                            rectangle: (self.x, self.y, self.width, self.height)
                            width: 2
                        
                        # Draw corner markers
                        # Top-left
                        Line:
                            points: self.x, self.y + 20, self.x, self.y, self.x + 20, self.y
                            width: 2
                        # Top-right
                        Line:
                            points: self.right - 20, self.y, self.right, self.y, self.right, self.y + 20
                            width: 2
                        # Bottom-left
                        Line:
                            points: self.x, self.top - 20, self.x, self.top, self.x + 20, self.top
                            width: 2
                        # Bottom-right
                        Line:
                            points: self.right - 20, self.top, self.right, self.top, self.right, self.top - 20
                            width: 2
            
            # Scanning animation
            BoxLayout:
                size_hint: 0.7, 0.1
                pos_hint: {'center_x': 0.5, 'top': 0.6}
                canvas:
                    Color:
                        rgba: 1, 1, 1, 0.7
                    Rectangle:
                        pos: self.pos
                        size: self.size
                
                MDLabel:
                    text: 'Align QR code within the frame'
                    halign: 'center'
                    valign: 'middle'
                    theme_text_color: 'Primary'
                    font_style: 'Body1'
                    color: 0, 0, 0, 1
        
        # Instructions
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: dp(100)
            padding: dp(16)
            spacing: dp(8)
            
            MDLabel:
                text: 'How to scan:'
                font_style: 'H6'
                halign: 'center'
                size_hint_y: None
                height: self.texture_size[1]
                
            MDLabel:
                text: '1. Ask the restaurant staff for their Billo QR code\n2. Align the code within the frame\n3. Hold steady until scanned'
                halign: 'center'
                theme_text_color: 'Secondary'
                font_style: 'Body2'
                size_hint_y: None
                height: self.texture_size[1] * 3
        
        # Action Buttons
        BoxLayout:
            size_hint_y: None
            height: dp(56)
            spacing: dp(16)
            
            MDFlatButton:
                text: 'Cancel'
                on_release: app.root.current = 'dashboard'
                
            MDFloatingActionButton:
                id: scan_btn
                icon: 'qrcode-scan' if not root.is_scanning else 'stop'
                on_release: root.start_scanning() if not root.is_scanning else root.stop_scanning()
                disabled: not root.has_camera_permission or root.demo_mode
                pos_hint: {'center_x': 0.5, 'center_y': 0.1}
                md_bg_color: app.theme_cls.primary_color if not root.is_scanning else app.theme_cls.error_color
